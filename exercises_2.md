
# BME 17 2η άσκηση

## Οδηγίες
Για να μπορέσετε να υλοποιήσετε τα βήματα αυτής της άσκηση θα πρέπει να έχετε έναν υπολογιστή με Linux. Σε αυτόν τον υπολογιστή θα πρέπει να ανοίξετε ένα περιβάλλον γραμμής εντολών και απλά να εκτελέσεται τις εντολές των βημάτων. 

## Τι πρέπει να παραδώσετε
Σε αυτή την άσκηση θα πρέπει να ετοιμάσετε μία αναφορά όπου για κάθε βήμα θα αναφέρετε:
1. Τι τρέξατε
2. Γιατί το τρέξατε
3. Τι παρήγαγε, και τι output είχαν οι εντολές, μπορείτε να βάλετε και screenshots
4. Οτιδήποτε επιπλέον ζητάει το κάθε βήμα


## Εισαγωγή
Ένας ασθενής καταυθάνει στο εργαστήριο γενετικής ανάλυσής σας, με μία ασθένεια νευρολογικής φύσεως που δεν έχει μπορέσει κανείς να διαγνώσει με ακρίβεια.
Αμέσως εσείς παραγγέλνετε να γίνει αλληλούχιση του γονιδιώματος του ασθενή. Το αποτέλεσμα της αλλούχισης καταυθάνουν και καλείστε να κάνετε τη βιοπληροφορική ανάλυση που απαιτείται για τη διάγνωση της ασθένειας. Θα πρέπει επομένως να κάνετε τα παρακάτω βήματα:

## Βήματα
Πριν ξεκινήσετε καλό είναι να επιβεβαιώσετε ότι έχετε εγκατεστημένο το πρόγραμμα `wget`. Αν όχι, μπορείτε να το εγκαταστήσετε με:
```bash
sudo apt-get update
sudo apt-get install -y wget 
```

### Βήμα 1
Εγκαταστήστε miniconda https://docs.conda.io/en/latest/miniconda.html . Αν έχετε ήδη miniconda αγνοήστε αυτό το βήμα.

Από τη γραμμή εντολών αυτό μπορεί να γίνει με:

```bash
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh 
bash Miniconda3-latest-Linux-x86_64.sh -b 
```

Αφού ολοκληρωθούν τα παραπάνω βήματα, θα πρέπει να βγείτε από το terminal και να ξαναμπείτε. 

### Βήμα 2
Δημιουργήστε ένα περιβάλλον conda το οποίο να περιέχει όλο το λογισμικό που θα χρειαστείτε για αυτή την ανάλυση. Για να γίνει αυτό κατεβάστε το αρχείο: [bme17.yml](bme17.yml). Αυτό μπορεί να γίνει και με:

```bash
wget -O bme17.yml https://raw.githubusercontent.com/kantale/BME_17/main/bme17.yml
``` 

Στη συνέχειατρέξτε:

```bash
conda env create -n bme17 -f bme17.yml 
```

Στη συνέχεια ενεργοποιήστε το περιβάλλον με:

```bash
conda activate bme17
```

### Βήμα 3
Κατεβάσε τα αρχεία με τα reads από την αλληλούχιση του DNA του ασθενή. To πείραμα αυτό έγινε με [pair end sequencing](https://thesequencingcenter.com/knowledge-base/what-are-paired-end-reads/) και τα αρχεία είναι σε φορμά [FASTQ](https://en.wikipedia.org/wiki/FASTQ_format) και συμπιεσμένα: 
* https://www.dropbox.com/s/cceg7m0pc9m1f5d/bme17.r1.fastq.gz?dl=0
* https://www.dropbox.com/s/u3m2gltlwqwb99q/bme17.r2.fastq.gz?dl=0 

Σε αυτό το βήμα θα πρέπει να κατεβάσετε και να αποσυμπιέσετε τα αρχεία.

Ένας τρόπος να το κάνετε αυτό από τη γραμμή εντολών είναι με:
```bash
wget -O bme17.r1.fastq.gz "https://www.dropbox.com/s/cceg7m0pc9m1f5d/bme17.r1.fastq.gz?dl=1"
wget -O bme17.r2.fastq.gz "https://www.dropbox.com/s/u3m2gltlwqwb99q/bme17.r2.fastq.gz?dl=1" 

gunzip bme17.r1.fastq.gz
gunzip bme17.r2.fastq.gz
```


### Βήμα 4 
Τρέξτε την εντολή:

```bash
fastqc bme17.r1.fastq 
```

Αυτή η εντολή θα τρέξει το πρόγραμμα [fastqc](https://www.bioinformatics.babraham.ac.uk/projects/fastqc/) (FASTQ - Quality Control) στο πρώτο αρχείο (R1) με τα reads. Βάλτε το γράφημα το οποίο περιέχει το "Per base sequence quality" στην αναφορά σας. Σχολιάστε την. 

### Βήμα 5
Κατεβάστε και αποσυμπιέστε το χρωμόσωμα 22 από το γωνιδίωμα αναφοράς στην έκδοση HG38 από αυτό το link: https://hgdownload.soe.ucsc.edu/goldenPath/hg38/chromosomes/chr22.fa.gz . Για την ανάλυσή μας θα χρησιμοποιήσουμε αυτό το γονιδίωμα αναφοράς. Σημείωση: Η μετάλλαξη που προκαλεί την ασθένειά μας βρίσκεται στο χρωμόσωμα 22.   


Από Linux μπορείτε και να τρέξετε τις παρακάτω εντολές:
```bash
wget https://hgdownload.soe.ucsc.edu/goldenPath/hg38/chromosomes/chr22.fa.gz 
gunzip -c chr22.fa.gz > chr22.fa 
```

### Βήμα 6
Για να μπορέσουν τα προγράμματα ανάλυσης να διαβάζουν γρήγορα το γονιδίωμα αναφορά θα πρέπει να το κάνετε "[index](http://www.htslib.org/doc/samtools-faidx.html)" . Αυτό γίνεται με τη παρακάτω εντολή:

```bash
samtools faidx chr22.fa
```

### Βήμα 7
Το επόμενο βήμα είναι να γίνει η στοίχιση των reads στο γονιδίωμα αναφοράς (alignment). Για να γίνει αυτό θα χρησιμοποιήσουμε το πρόγραμμα [bowtie2](http://bowtie-bio.sourceforge.net/bowtie2/index.shtml). Δυστυχώς το bowtie2 χρησιμοποιεί το δικό του index το οποίο είναι διαφορετικό από το index από το samtools. Για να φτιάξετε το index του γονιδιώματος αναφοράς σύμφωνα με το φορμάτ του bowtie2 πρέπει να τρέξετε:

```bash
bowtie2-build chr22.fa chr22
```

### Βήμα 8
Μετά το βήμα 7 είμαστε έτοιμοι επιτέλους για το aligment. Τρέχτε τη παρακάτω εντολή:

```bash
bowtie2 -x chr22 -q -1 bme17.r1.fastq -2 bme17.r2.fastq -S bme.sam
```

Αυτή η εντολή παίρνει τα pair-ends reads και τα κάνει align στο γονιδίωμα αναφοράς. Το αποτέλεσμα αποθηκεύεται στο αρχείο bme.sam το οποίο είναι σε [sam φορμά](https://en.wikipedia.org/wiki/SAM_%28file_format%29). 

### Βήμα 9
Το SAM είναι ένα φορμάτ αρχείο κειμένου το οποίο είναι εύκολο να το διαβάσουμε αλλά καταλαμβάνει πολύ χώρο στον σκληρό μας δίσκο. Για αυτό μας βολεύει να το μετατρέπουμε στο αντίστοιχο δυαδικό (binary) φορμά το οποίο ονομάζεται [BAM](https://en.wikipedia.org/wiki/Binary_Alignment_Map) με τη παρακάτω εντολή:

```bash
samtools view -S -b bme17.sam > bme.bam
````

### Βήμα 10
Τα BAM αρχείο που έχουμε φτιάξει περιέχει όλα τα reads στοιχισμένα στο γονιδίωμα ααφοράς, αλλά δεν είναι ταξινομημένα κάτι που δυσχεραίνει την επεξεργασία τους. Η παρακάτω εντολή ταξινομεί το BAM αρχείο:

```bash
samtools sort bme.bam > bme17.sorted.bam
````

### Βήμα 11 
Τώρα που είναι ταξινομημένο, μπορούμε να κάνουμε index το αρχείο `bme17.sorted.bam` για να μπορούμε να πηγαίνουμε εύκολα σε οποιαδήποτε σημείο του:
```bash
samtools index bme17.sorted.bam 
```

### Βήμα 12 (προαιρετικό)
Τώρα που έχουμε φτιάξει ένα φανταστικό aligment αρχείο μπορούμε να το οπτικοποιήσουμε και να περιηγηθούμε σε αυτό μέσω του προγράμματος [IGV](https://software.broadinstitute.org/software/igv/). Για να γίνει όμως αυτό θα πρέπει ο υπολογιστής σας να διαθέτει γραφικό περιβάλλον (π.χ. να μην τρέχετε αυτά τα βήματα από υπολογιστή με απομακρυσμένη σύνδεση). Αν δεν έχετε λοιπόν γραφικό περιβάλλον, μπορείτε να αγνοήσετε αυτό το βήμα. Διαφορετικά μπορείτε να τρέξετε: 

```bash
igv bme17.sorted.bam
``` 

Όταν ανοίξει το πρόγραμμα περιήγησης μπορείτε να πάτε στη περιοχή του χρωμοσώματος 22 κοντά στη θέση 21.000.000 και να πάρετε ένα screenshot με τη στοίχιση των reads. 

### Βήμα 13
Τώρα που είμαστε σίγουροι ότι το αρχείο με το alignment είναι σωστό, ήρθε η ώρα να ψάξουμε για μεταλλάξεις που υπάρχουν μέσα στα reads σε σχέση με το γονιδίωμα αναφοράς. Αυτή η διαδικασία ονομάζεται variant calling. Υπάρχει μία τεράστια συλλογή από προγράμματα που κάνουν variant calling. Ένα από αυτά είναι το [bcftools](http://samtools.github.io/bcftools/bcftools.html). H ενολή για να κάνουμε variant call με το bctools είναι:

```bash
bcftools mpileup -f chr22.fa bme17.sorted.bam | bcftools call -mv -Ov -o bme.vcf
```

Η εντολή αυτή παράγει ένα αρχείο σε φορμά [VCF](https://en.wikipedia.org/wiki/Variant_Call_Format) το οποίο περιέχει όλες τις μεταλλάξεις που περιέχει το δείγμα μας. 

###  Βήμα 14 
Το αρχείο `bme17.vcf`, περιέχει πολλές χιλιάδες μεταλλάξεις, αλλά ποια από αυτές ευθύνεται για τα συμπτώματα που αντιμετωπίζει ο ασθενής μας; Για να το βρούμε αυτό θα πρέπει να ρωτήσουμε τις ανοικτές βάσεις βιολογικών δεδομένων. Αυτό το βήμα ονομάζεται `variant annotation`. Ένα από τα προγράμματα που το κάνει αυτό είναι το [VEP](https://www.ensembl.org/info/docs/tools/vep/index.html) (Variant Effect Predictor). Η πληροφορία που μπορεί να προσθέσει το VEP είναι τεράστια (δείτε [εδώ](https://www.ensembl.org/info/docs/tools/vep/script/vep_options.html) για μία λίστα), για να διαχειριστεί αυτή τη πληροφορία το VEP δουλεύει με δύο δυνατούς τρόπους:

* **Τρόπος 1:** Κατεβάζει τοπικά όλη τη πληροφορία στον σκληρό σας δίσκο. Όπως καταλαβαίνεται αυτό παίρνει πολύ χώρο στον δίσκο σας, αλλά αφού τα κατεβάσει, κάνει τη διαδικασία του annotation πολύ γρήγορη. Αν διαλέξετε αυτόν τον τρόπο θα πρέπει να τρέξετε τη παρακάτω εντολή και ενδεχομένως να περιμένετε αρκετή ώρα:
```bash
vep_install -a cf -s homo_sapiens -y GRCh38 -c ~vep/ --CONVERT 
```

Όταν ολοκληρωθεί η παραπάνω εντολή θα μπορείτε να κάνετε annotate το αρχείο `bme17.vcf` με τη παρακάτω εντολή:
```bash
vep -i bme17.vcf --cache --dir_cache ~vep/ --offline --everything --vcf -o bme17.annotated.vcf  
```

* **Τρόπος 2:** Μπορείτε να αποφύγετε να κατεβάσετε όλη τη γενετική πληροφορία στον υπολογιστή σας λέγοντας στο VEP, να την αναζητήσει απευθείας στο Internet. Αυτό το βήμα δεν απαιτεί χώρο στον σκηρό σας δίσκο, αλλά κάνει αρκετή ώρα να ρωτήσει τις γενετικές βάσεις δεδομένων:

```bash
vep -i bme17.vcf  --database --polyphen b --sift b --check_existing  --vcf -o bme17.annotated.vcf   
```

Παρατηρήστε ότι με τον 1ο τρόπο προσθέτουμε ΟΛΗ τη δυνατή πληροφορία που υπάρχει (`--everything`) γιατί είναι "φθηνό", αφού η πληροφορία είναι ήδη κατεβασμένη στον υπολογιστή μας. Με τον 2ο τρόπο όμως προσθέτουμε μόνο τη πρόβλεψη της παθογένειας της μετάλλαξης μέσω των προγραμμάτω polyphen και sift. Επίσης ελέγχουμε αν η μετάλλαξη υπάρχει σε άλλες βάσεις δεδομένων (`--check_existing`). Επιλέγουμε δηλαδή να προσθέσει την ελάχιστη πληροφορία που θέλουμε. γιατί το να προσθέσουμε πληροφορία είναι "ακριβό". 

Το αρχείο `bme17.annotated.vcf` που παράγεται με έναν από τους 2 τρόπους, περιέχει όλη τη πληροφορία που έχουν εντοπιστεί από τις βιολογικές βάσεις δεδομένων σχετικά με τις μεταλλάξεις που έχουμε εντοπίσει. 


### Βήμα 15
Ωραία, όλα αυτά αλλά ακόμα δεν έχουμε απαντήσει στο αρχικό μας ερώτημα. Το αρχείο `bme17.annotated.vcf` εξακολουθεί να περιέχει χιλιάδες μεταλλάξεις και ακόμα δεν ξέρουμε ποια είναι υπεύθυνη για τα συμπτώματα του ασθενή. Αν και υπάρχουν πολλοί τρόποι για να ενοπίζουμε πληροφορία μέσα σε αυτό το αρχείο, εδώ θα κάνουμε κάτι πολύ απλό. Απλά θα αναζητήσουμε ποια γραμμή περιέχει το `likely_pathοgenic` μέσα στο αρχείο (`grep "likely_pathogenic"`). Στη συνέχεια θα αναζητήσουμε όλους του κωδικούς dbSNP που υπάρχουν μέσα σε αυτό το αρχείο (`grep -ohE "rs\d+"`) και επειδή ο κωδικός υπάρχει πολλές φορές θα του πούμε να τυπώσει μόνο τη πρώτη (`uniq`). Όλα αυτά γίνονται με τη παρακάτω εντολή:

```bash
grep "likely_pathogenic" bme17.annotated.vcf | grep -ohE "rs[0-9]+"  | uniq
```
Αν κάνετε αυτό, θα τυπώσει τον dbSNP κωδικό μίας μετάλλαξης (`rsXXXXXX`), όπου X είναι αριθμοί. Ποιος είναι ο κωδικός της μετάλλαξης;

### Βήμα 16
Βρήκαμε τον dbSNP κωδικό της μετάλλαξης αλλά δεν βρήκαμε την ασθένεια. Θα πρέπει να πάτε στη βάση δεδομένων [dbSNP](https://www.ncbi.nlm.nih.gov/snp/) και να εισάγεται το κωδικό dbSNP της μετάλλαξης. Στη σελίδα που θα εμφανίσει θα εμφανιστεί και μία λίστα με "καρτέλες". Μία από αυτές θα ονομάζεται: "Clinical Significance". Αν την επιλέξετε θα εμφανιστεί ένας πίνακας. Μία από τις στήλες του πίνακα είναι και το `Disease Name`. Σε αυτή τη στήλη θα εμφανίζεται και η ασθένεια η οποία έχει συσχετιστεί με αυτή τη μετάλλαξη (αγνοήστε τις τιμές `not provided`). Ποια είναι αυτή η σσθένεια;













